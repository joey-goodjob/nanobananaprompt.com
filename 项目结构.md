# Nanobanana Prompt 项目结构分析

## 项目概览

这是一个基于 **Next.js 14** 的 Prompt 展示网站，使用 **Turbo Monorepo** 架构，通过远程 CMS（Payload CMS）管理内容。

---

## 核心架构

### CMS 配置

**配置文件**: apps/nanobananaPrompt/lib/cms-client.ts:27-51

```
CMS 地址: https://cms.vumiai.com
├── Tenant ID: 多租户隔离
├── API Endpoints:
│   ├── /api/landing-pages  (落地页/单页文章)
│   └── /api/posts          (文章列表)
└── 缓存策略: 60秒 revalidate
```

**环境变量**:
- `NEXT_PUBLIC_CMS_HOST` - CMS 服务器地址
- `NEXT_PUBLIC_CMS_SECRET` - API 认证令牌
- `NEXT_PUBLIC_CMS_TENANT_ID` - 租户 ID

---

## 数据流向图

```
CMS (Payload)
https://cms.vumiai.com
    ↓
[cms-client.ts] 数据获取层
├── fetchArticlesClient()     → 获取文章列表
├── fetchPostClient()         → 获取单篇文章
├── fetchArticleClient()      → 获取落地页
└── fetchPostByIdClient()     → 通过 ID 获取文章
    ↓
[数据标准化层]
├── normalizeArticle()        → 统一字段格式
├── normalizeBlocks()         → 标准化内容块
├── normalizeTags()           → 处理标签
└── getImageUrl()             → 统一图片字段
    ↓
[页面组件层]
├── HomePage                  → 首页
├── ArticlePage               → 文章详情页
└── PromptsPage               → Prompt导航页
```

---

## 主要页面和数据使用

### 首页 (apps/nanobananaPrompt/app/page.tsx)

**数据获取**:
```typescript
const articleResponse = await fetchArticlesClient({ limit: 18 });
```

**显示组件**:
1. **Hero 区域**
   - 显示总文章数: `{total}+`
   - 显示最新文章发布时间: `featuredArticle.publishedAt`

2. **ArticleSection**
   - 文章网格列表
   - 支持分页加载更多
   - 语言切换自动刷新

3. **其他静态区块**
   - WhyChooseSection (为什么选择)
   - TutorialsGuidesSection (教程指南)
   - InspirationGallerySection (灵感画廊)
   - CommunityShowcaseSection (社区展示)
   - FaqSection (常见问题)
   - CtaSection (行动号召)

---

### 文章详情页 (apps/nanobananaPrompt/app/posts/[slug]/page.tsx)

**数据获取**:
```typescript
const article = await fetchPostClient(slug);
```

**显示内容**:
- 面包屑导航
- 文章标题、描述、封面图
- 发布/更新时间、分类、标签
- **内容块渲染** (优先级):
  1. `blocks[]` - 结构化内容块（标题+段落+图片）
  2. `htmlContent` - HTML 富文本（备用）
  3. `description/excerpt` - 纯文本（兜底）
- 侧边栏实用建议
- 返回链接

**路径生成策略**:
```typescript
// 构建时预生成前50篇文章的静态页面
generateStaticParams() {
  fetchArticlesClient({ limit: 50 })
}
```

---

## 客户端交互逻辑

### 文章列表组件 (apps/nanobananaPrompt/app/_components/article/index.tsx)

**核心功能**:

1. **语言切换响应**
```typescript
useEffect(() => {
  fetchArticlesClient({
    limit: pageSize,
    page: 1,
    locale: language.locale
  });
}, [language.locale]);
```

2. **分页加载更多**
```typescript
handleLoadMore() {
  const response = await fetchArticlesClient({
    page: page + 1,
    locale: language.locale
  });
  mergeArticles(response.items); // 去重合并
}
```

3. **去重逻辑**
```typescript
const existingIds = new Set(prev.map(item => item.id));
const appended = nextItems.filter(item => !existingIds.has(item.id));
```

**状态管理**:
- `loading` - 初始加载/语言切换加载
- `loadingMore` - 加载更多状态
- `error` - 错误信息
- `hasMore` - 是否还有更多页面

---

## CMS 数据结构

### Article 类型 (apps/nanobananaPrompt/types/cms.ts)

```typescript
{
  id: string                // 唯一标识
  slug: string              // URL 路径
  title: string             // 标题
  description?: string      // SEO 描述
  excerpt?: string          // 摘要
  coverImage?: string       // 封面图 URL
  htmlContent?: string      // HTML 内容（备用）
  blocks: ArticleBlock[]    // 结构化内容块
  publishedAt?: string      // 发布时间
  updatedAt?: string        // 更新时间
  category?: string         // 分类
  tags?: string[]           // 标签数组
  status?: string           // 状态 (published/draft)
}
```

### ArticleBlock 结构

支持的字段组合:

| 字段类型 | 可能的字段名 | 用途 |
|---------|------------|------|
| **标题** | `heading`, `subheading`, `blockName`, `title` | 块标题 |
| **内容** | `content`, `richText`, `text`, `body`, `html` | 文本内容 |
| **图片** | `coverImage`, `image`, `media`, `asset`, `heroImage` | 图片资源 |
| **元数据** | `blockType`, `id` | 块类型标识 |

**示例 Block**:
```typescript
{
  blockType: "content",
  heading: "什么是 Prompt?",
  content: [
    { type: "paragraph", text: "..." },
    { type: "list", items: [...] }
  ],
  image: { url: "https://..." }
}
```

---

## CMS 字段映射规则

**文件**: apps/nanobananaPrompt/lib/cms-client.ts:161-220

CMS 返回的原始数据会被标准化为统一格式:

| CMS 原始字段 | 标准化后 | 优先级/规则 |
|-------------|---------|-----------|
| `slug` / `handle` / `id` | `slug` | slug > handle > id |
| `coverImage` / `featuredImage` / `heroImage` / `thumbnail` | `coverImage` | 按顺序查找第一个 |
| `title` / `heroTitle` | `title` | title > heroTitle > slug |
| `description` / `excerpt` / `summary` | `description` | description > excerpt > summary |
| `excerpt` / `summary` / `description` | `excerpt` | excerpt > summary > description |
| `content` / `sections` / `layout` / `blocks` / `body` | `blocks` | 任意一个存在 |
| `tags` / `keywords` | `tags` | 拆分字符串或直接使用数组 |
| `category` / `categories[0]` | `category` | 单个或取第一个 |
| `_status` / `status` / `published` | `status` | _status > status > (published ? "published" : "draft") |

**智能处理**:
- 图片字段: 支持 `string` 或 `{ url: string }` 对象
- 标签字段: 支持数组或逗号分隔的字符串
- 内容块: 自动标准化为数组格式

---

## 页面渲染逻辑

### 首页 Hero (apps/nanobananaPrompt/app/_components/hero/index.tsx)

```typescript
<div className={styles.stats}>
  <div className={styles.stat}>
    <p className={styles.statValue}>{totalArticles}+</p>
    {/* 从 articleResponse.total 获取 */}
  </div>
  <div className={styles.stat}>
    <p className={styles.statValue}>
      {formatArticleDate(featuredArticle.publishedAt)}
    </p>
    {/* 显示第一篇文章的发布时间 */}
  </div>
</div>
```

### 文章内容渲染 (apps/nanobananaPrompt/app/posts/[slug]/article-content.tsx)

**渲染优先级**:
1. 优先渲染 blocks - 结构化内容块
2. 降级到 htmlContent - HTML 富文本
3. 兜底显示 description/excerpt

**Block 渲染逻辑**:
```typescript
function renderBlock(block, index) {
  const heading = blockHeading(block);       // 提取标题
  const paragraphs = blockParagraphs(block); // 提取段落
  const image = blockImage(block);           // 提取图片

  return (
    <section>
      {heading && <h3>{heading}</h3>}
      {image && <div style={{backgroundImage: `url(${image})`}} />}
      {paragraphs.map(text =>
        /<\w+/.test(text)  // 检测是否包含 HTML 标签
          ? <div dangerouslySetInnerHTML={{__html: text}} />
          : <p>{text}</p>
      )}
    </section>
  );
}
```

**文本提取算法**:
```typescript
function gatherTextChunks(value) {
  // 递归提取嵌套结构中的文本
  // 支持: string, array, {html}, {text}, {content}, {children}, {root}, {value}
}
```

---

## 性能优化策略

### 1. ISR (Incremental Static Regeneration)

```typescript
// apps/nanobananaPrompt/app/page.tsx
export const revalidate = 60; // 每60秒重新验证缓存
```

- 构建时生成静态页面
- 运行时后台更新
- 用户始终看到快速响应

### 2. Static Path 预生成

```typescript
// apps/nanobananaPrompt/app/posts/[slug]/page.tsx
export async function generateStaticParams() {
  const articleResponse = await fetchArticlesClient({ limit: 50 });
  return articleResponse?.items.map(article => ({ slug: article.slug })) ?? [];
}
```

- 构建时生成前 50 篇文章的静态页面
- 其他文章按需生成 (dynamicParams: true)

### 3. 客户端缓存策略

```typescript
function getBaseFetchOptions() {
  if (isBrowser) {
    return { cache: "no-store" };  // 浏览器端不缓存，确保实时性
  }
  return {
    next: { revalidate: 60 }  // 服务端使用 ISR 缓存
  };
}
```

### 4. 数据去重

```typescript
// 避免重复显示相同文章
const existingIds = new Set(prev.map(item => item.id));
const appended = nextItems.filter(item => !existingIds.has(item.id));
```

---

## 实用工具函数

### 日期格式化 (apps/nanobananaPrompt/lib/article-utils.ts)

```typescript
formatArticleDate(value, variant: "short" | "long")
// short: "2024年1月15日"
// long:  "2024年1月15日"
```

### 文章描述提取 (apps/nanobananaPrompt/lib/article-utils.ts)

```typescript
getArticleDescription(article)
// 优先级: excerpt > description > htmlContent纯文本 > 默认文案
```

### 标签可读化 (apps/nanobananaPrompt/lib/article-utils.ts)

```typescript
readableTag("seo-optimization")
// 输出: "SEO OPTIMIZATION"
```

---

## API 请求示例

### 获取文章列表

```
GET https://cms.vumiai.com/api/posts?
  where[tenant][equals]=1&
  where[published][equals]=true&
  limit=12&
  page=1&
  locale=en
```

**响应**:
```json
{
  "docs": [...],
  "totalDocs": 42,
  "totalPages": 4,
  "page": 1,
  "limit": 12
}
```

### 获取单篇文章

```
GET https://cms.vumiai.com/api/posts?
  where[tenant][equals]=1&
  where[slug][equals]=seo-best-practices&
  where[published][equals]=true&
  depth=2&
  locale=en
```

---

## 多语言支持

**实现位置**: apps/nanobananaPrompt/app/_components/language-provider

```typescript
const { language } = useLanguage();
// language.locale: "en" | "zh" | ...

// 切换语言时自动重新获取数据
useEffect(() => {
  fetchArticlesClient({ locale: language.locale });
}, [language.locale]);
```

---

## 项目文件结构

```
apps/nanobananaPrompt/
├── app/
│   ├── page.tsx                          # 首页
│   ├── posts/[slug]/
│   │   ├── page.tsx                      # 文章详情页
│   │   └── article-content.tsx           # 文章内容组件
│   ├── prompts/page.tsx                  # Prompt导航页
│   └── _components/                      # 共享组件
│       ├── article/                      # 文章列表
│       ├── article-list/                 # 文章网格
│       ├── hero/                         # 首页Hero
│       ├── language-provider/            # 语言切换
│       └── ...
├── lib/
│   ├── cms-client.ts                     # CMS 数据获取核心
│   └── article-utils.ts                  # 工具函数
├── types/
│   └── cms.ts                            # TypeScript 类型定义
└── package.json
```

---

## 总结

### CMS 读取的内容:
- 文章列表（标题、摘要、封面、分类、标签、阅读时间）
- 文章详情（完整内容块、富文本、元数据）
- 分页信息（总数、总页数、当前页）
- 落地页内容（通过 landing-pages API）

### 显示位置:
- **首页**:
  - Hero 区域显示总文章数和最新更新时间
  - ArticleSection 显示文章网格列表（18篇）
  - 支持"加载更多"分页

- **文章详情页**:
  - 完整文章内容（blocks 或 htmlContent）
  - 面包屑导航
  - 元数据（发布时间、更新时间、分类、标签）
  - 侧边栏实用建议

- **动态交互**:
  - 支持无限滚动加载更多
  - 语言切换自动刷新内容
  - 实时同步最新 CMS 数据

### 关键特性:
- 多语言: 通过 `locale` 参数切换
- 多租户: 通过 `tenant` 参数隔离
- 高性能: ISR + SSG + 客户端缓存
- 实时更新: 客户端自动刷新最新内容
- 类型安全: 完整的 TypeScript 类型定义
- 灵活渲染: 支持结构化块和 HTML 富文本

### 数据流向核心:
```
CMS API → cmsFetch → normalizeArticle → React Components → 用户界面
```

---

## 开发建议

1. **添加新字段**: 在 `normalizeArticle()` 中添加映射逻辑
2. **修改缓存**: 调整 `revalidate` 值
3. **自定义 Block 类型**: 扩展 `ArticleBlock` 类型并修改渲染逻辑
4. **优化性能**: 增加 `generateStaticParams` 的 limit 值
5. **调试 CMS**: 检查 `[CMS]` 前缀的 console 日志
